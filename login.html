<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calpe Ward - Login</title>

  <!-- Supabase JS (v2) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- PWA / iOS Home Screen -->
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Calpe Ward Requests">
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Config -->
  <script src="js/config.js" defer></script>

  <style>
    :root {
      --grid: #d9d9d9;
      --grid-soft: #ececec;
      --text: #111;
      --muted: #6b6b6b;
      --header: #f4f4f4;
      --sheet-bg: #ffffff;
      --sep: #c0c0c0;
      --sep-fill: #e3e3e3;
      --closed-fill: #f0f0f0;
      --weekend-fill: #fafafa;
      --cn-band: #a8e6a1;
      --sn-band: #9fd0ff;
      --na-band: #ffd18a;
      --accent: #4F8DF7;
      --accent-hover: #2F6FEA;
      --accent-weak: rgba(79,141,247,0.16);
      --accent-weak-hover: rgba(79,141,247,0.24);
      --ink: #0f172a;
      --card: #ffffff;
      --line: #e6e8ee;
      --soft: #f6f7fb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Manrope", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
      color: var(--text);
      background: linear-gradient(135deg, #f7f7f7 0%, #f0f0f0 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-container {
      width: 100%;
      max-width: 420px;
      padding: 20px;
    }

    .login-card {
      background: var(--sheet-bg);
      border: 1px solid var(--grid);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      padding: 40px 32px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .logo-section {
      margin-bottom: 20px;
    }

    .logo-section img {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 28px;
      font-weight: 800;
      margin: 16px 0 8px 0;
      color: var(--ink);
      letter-spacing: -0.5px;
    }

    .subtitle {
      font-size: 14px;
      color: var(--muted);
      margin: 0;
    }

    .form-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }

    input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--grid-soft);
      border-radius: 8px;
      font-family: inherit;
      font-size: 15px;
      color: var(--text);
      background: var(--soft);
      transition: all 0.2s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--sheet-bg);
      box-shadow: 0 0 0 3px var(--accent-weak);
    }

    input::placeholder {
      color: var(--muted);
    }

    .pin-input-group {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 6px;
    }

    .pin-digit {
      padding: 12px 0 !important;
      text-align: center;
      font-size: 24px !important;
      font-weight: 700;
      letter-spacing: 0.1em;
      font-family: "Monaco", "Menlo", monospace;
    }

    .error-message {
      display: none;
      color: #dc2626;
      font-size: 13px;
      margin-top: 6px;
      padding: 8px 12px;
      background: #fee2e2;
      border: 1px solid #fecaca;
      border-radius: 6px;
      line-height: 1.4;
    }

    .error-message.show {
      display: block;
    }

    .success-message {
      display: none;
      color: #15803d;
      font-size: 13px;
      margin-top: 6px;
      padding: 8px 12px;
      background: #dcfce7;
      border: 1px solid #86efac;
      border-radius: 6px;
      line-height: 1.4;
    }

    .success-message.show {
      display: block;
    }

    .submit-btn {
      width: 100%;
      padding: 12px 16px;
      margin-top: 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      box-shadow: 0 2px 8px rgba(79, 141, 247, 0.3);
    }

    .submit-btn:hover:not(:disabled) {
      background: var(--accent-hover);
      box-shadow: 0 4px 12px rgba(79, 141, 247, 0.4);
      transform: translateY(-1px);
    }

    .submit-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .footer-text {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      margin-top: 24px;
      line-height: 1.5;
    }

    .loading-spinner {
      display: none;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .submit-btn.loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .submit-btn.loading .loading-spinner {
      display: block;
    }

    .submit-btn.loading span {
      margin-right: 0;
    }

    @media (max-width: 480px) {
      .login-card {
        padding: 32px 24px;
      }

      h1 {
        font-size: 24px;
      }

      .logo-section img {
        width: 50px;
        height: 50px;
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <div class="logo-section">
          <img src="logo.png" alt="Calpe Ward Logo" />
        </div>
        <h1>Calpe Ward</h1>
        <p class="subtitle">Off Duty Requests</p>
      </div>

      <form id="loginForm">
        <!-- Username -->
        <div class="form-group">
          <label for="username">Username</label>
          <input
            type="text"
            id="username"
            name="username"
            placeholder="Enter your username"
            autocomplete="username"
            required
          />
        </div>

        <!-- PIN -->
        <div class="form-group">
          <label>PIN</label>
          <div class="pin-input-group">
            <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" />
            <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" />
            <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" />
            <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" />
          </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message"></div>

        <!-- Success Message -->
        <div id="successMessage" class="success-message"></div>

        <!-- Submit Button -->
        <button type="submit" class="submit-btn" id="submitBtn">
          <span id="btnText">Sign In</span>
          <div class="loading-spinner"></div>
        </button>
      </form>

      <div class="footer-text">
        <p>Secure login with PIN authentication</p>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "calpe_ward_session";
    const TOKEN_KEY = "calpe_ward_token";
    
    let supabaseClient = null;

    // Initialize Supabase
    function initSupabase() {
      if (typeof window.SUPABASE_URL !== 'undefined' && typeof window.SUPABASE_ANON !== 'undefined') {
        supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON);
      }
    }

    // PIN input auto-advance
    document.querySelectorAll('.pin-digit').forEach((input, index) => {
      input.addEventListener('input', (e) => {
        if (e.target.value.length === 1 && index < 3) {
          document.querySelectorAll('.pin-digit')[index + 1].focus();
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
          document.querySelectorAll('.pin-digit')[index - 1].focus();
        }
      });
    });

    // Form submission
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('username').value.trim();
      const pinDigits = Array.from(document.querySelectorAll('.pin-digit')).map(input => input.value).join('');
      const errorMsg = document.getElementById('errorMessage');
      const successMsg = document.getElementById('successMessage');
      const submitBtn = document.getElementById('submitBtn');

      // Clear messages
      errorMsg.classList.remove('show');
      successMsg.classList.remove('show');
      errorMsg.textContent = '';
      successMsg.textContent = '';

      // Validation
      if (!username) {
        showError('Please enter your username');
        return;
      }

      if (pinDigits.length !== 4) {
        showError('PIN must be 4 digits');
        return;
      }

      if (!/^\d{4}$/.test(pinDigits)) {
        showError('PIN must contain only digits');
        return;
      }

      // Disable submit and show loading
      submitBtn.disabled = true;
      submitBtn.classList.add('loading');

      try {
        if (!supabaseClient) {
          initSupabase();
        }

        if (!supabaseClient) {
          throw new Error('Supabase not initialized. Check config.js');
        }

        // Call login RPC
        const { data, error } = await supabaseClient.rpc('verify_login', {
          p_username: username,
          p_pin: pinDigits
        });

        if (error) {
          console.error('Login error:', error);
          showError(error.message || 'Login failed. Please check your username and PIN.');
          return;
        }

        if (!data || !data.token) {
          showError('Invalid response from server');
          return;
        }

        // Store token and redirect
        sessionStorage.setItem(TOKEN_KEY, data.token);
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify({
          token: data.token,
          user_id: data.user_id,
          username: username,
          logged_in_at: new Date().toISOString()
        }));

        showSuccess('Login successful! Redirecting...');

        // Redirect after brief delay
        setTimeout(() => {
          window.location.href = '/rota.html';
        }, 500);

      } catch (err) {
        console.error('Login exception:', err);
        showError('Network error. Please check your connection and try again.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
      }
    });

    function showError(message) {
      const errorMsg = document.getElementById('errorMessage');
      errorMsg.textContent = message;
      errorMsg.classList.add('show');
    }

    function showSuccess(message) {
      const successMsg = document.getElementById('successMessage');
      successMsg.textContent = message;
      successMsg.classList.add('show');
    }

    // Initialize on load
    window.addEventListener('load', () => {
      initSupabase();

      // If already logged in, redirect to rota
      const existingToken = sessionStorage.getItem(TOKEN_KEY);
      if (existingToken) {
        window.location.href = '/rota.html';
      }
    });
  </script>
</body>
</html>
