<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calpe Ward Admin Console</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="js/config.js"></script>
  <script src="js/session-validator.js"></script>
  <style>
    :root{
      --ink: #0f172a;
      --muted: #6b7387;
      --line: #e7ebf3;
      --soft: #f7f9fc;
      --panel: #ffffff;
      --accent: #5b7cfa;
      --accent-soft: rgba(91,124,250,0.12);
    }

    *{ box-sizing: border-box; }

    body{
      margin: 0;
      font-family: "Manrope", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
      color: var(--ink);
      background: var(--soft);
    }

    .layout{
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    .sidebar{
      background: #f4f6fb;
      border-right: 1px solid var(--line);
      padding: 20px 16px;
    }

    .brand{
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 14px;
    }

    .subbrand{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 20px;
    }

    .nav{
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .nav a{
      text-decoration: none;
      color: var(--ink);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid transparent;
    }

    .nav a:hover{
      background: #eef1f8;
      border-color: #e3e8f2;
    }

    .nav a.is-active{
      background: var(--accent-soft);
      border-color: rgba(91,124,250,0.2);
      color: var(--accent);
    }

    .main{
      padding: 24px;
    }

    .page-title{
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 4px 0;
    }

    .page-subtitle{
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 18px 0;
    }

    .grid{
      display: grid;
      gap: 16px;
    }

    .section{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
    }

    .section h2{
      font-size: 15px;
      margin: 0 0 10px 0;
      font-weight: 700;
    }

    .section p{
      margin: 0 0 12px 0;
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.4;
    }

    details.accordion{
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #ffffff;
      padding: 10px 12px;
    }

    details.accordion + details.accordion{
      margin-top: 10px;
    }

    details.accordion[open]{
      box-shadow: 0 6px 16px rgba(15,23,42,0.06);
    }

    summary.accordion-title{
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 700;
      color: var(--ink);
      padding: 4px 2px;
    }

    summary.accordion-title::-webkit-details-marker{ display:none; }

    .accordion-sub{
      margin-top: 8px;
      font-size: 12.5px;
      color: var(--muted);
    }

    .row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .field{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      background: #ffffff;
    }

    .field h3{
      margin: 0 0 6px 0;
      font-size: 13px;
      font-weight: 700;
    }

    .field p{
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .actions{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .subtabs{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 8px 0 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--line);
    }

    .subtab{
      color: var(--muted);
      padding: 6px 10px;
      font-size: 12.5px;
      font-weight: 600;
      border-radius: 8px;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
    }

    .subtab.is-active{
      color: var(--ink);
      border-color: #e3e8f2;
      background: #f5f7fb;
    }

    /* Edit User: Pattern + Permission Groups row */
    .edit-user-two-col{
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 14px;
      margin-bottom: 14px;
      align-items: stretch;
    }

    /* Make details act like equal-height cards */
    .edit-user-card{
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #ffffff;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      width: 100%;
      display: flex;
      flex-direction: column;
      min-height: 210px;
      padding: 0;
    }

    /* Key fix: body must fill remaining height */
    .edit-user-card-body{
      padding: 14px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #adminUserPermissionGroups{
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #adminUserPermissionGroups .perm-group-item{
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 12px;
      color: #374151;
      line-height: 1.25;
      margin: 0;
    }

    #adminUserPermissionGroups input[type="checkbox"]{
      width: 14px;
      height: 14px;
      margin: 0;
    }

    .control{
      width: 100%;
      height: 32px;
      padding: 4px 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #ffffff;
      font-size: 12.5px;
      color: var(--ink);
    }

    .control:focus{
      outline: none;
      border-color: rgba(91,124,250,0.4);
      box-shadow: 0 0 0 3px rgba(91,124,250,0.12);
    }

    .btn{
      height: 32px;
      padding: 0 14px;
      border-radius: 10px;
      border: 1px solid #e5eaf3;
      background: #ffffff;
      font-size: 12.5px;
      font-weight: 600;
      color: var(--ink);
      cursor: pointer;
    }

    .btn.primary{
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .user-group-title{
      padding: 8px 10px;
      font-weight: 700;
      font-size: 12px;
      color: var(--muted);
      background: #f4f6fb;
      border-top: 1px solid var(--line);
    }

    .user-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid var(--line);
      cursor: default;
    }

    .user-row:last-child{
      border-bottom: none;
    }

    .user-row.dragging{
      opacity: 0.5;
    }

    .user-row.drag-over{
      border-top: 2px solid var(--accent);
    }

    .drag-handle{
      cursor: grab;
      user-select: none;
      font-size: 14px;
      color: #c1c7d6;
      padding: 2px 4px;
      margin-right: 6px;
    }

    .user-meta{ min-width:0; }
    .user-name{
      font-weight: 600;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .user-actions{
      display:flex;
      gap: 6px;
      flex: 0 0 auto;
    }

    .user-tag{
      display:inline-block;
      margin-left: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid #e5eaf3;
      background: #f7f8fc;
      color: #4b5565;
    }

    .user-tag.admin{
      background: var(--accent-soft);
      border-color: rgba(91,124,250,0.25);
      color: var(--accent);
    }

    .user-tag.inactive{
      background: #f3f4f7;
      color: #6b7280;
    }

    .reorder-list .user-row{
      cursor: grab;
    }

    .table{
      width: 100%;
      border-collapse: collapse;
      font-size: 12.5px;
    }

    .table th,
    .table td{
      text-align: left;
      padding: 8px 6px;
      border-bottom: 1px solid var(--line);
    }

    .table th{
      color: var(--muted);
      font-weight: 600;
      font-size: 12px;
    }

    .permissions-block{
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #ffffff;
      padding: 12px;
      margin-bottom: 12px;
    }

    .permissions-title{
      font-size: 13px;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .permissions-row{
      display: grid;
      grid-template-columns: 1fr 110px;
      gap: 10px;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid var(--line);
    }

    .permissions-row:last-child{
      border-bottom: none;
    }

    .perm-label{
      font-size: 12.5px;
      font-weight: 600;
    }

    .perm-desc{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .perm-key{
      font-size: 11px;
      color: #94a3b8;
      margin-top: 2px;
    }

    .perm-accordion{
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #ffffff;
      padding: 0;
      overflow: hidden;
    }

    .perm-accordion + .perm-accordion{
      margin-top: 12px;
    }

    .perm-accordion summary{
      list-style: none;
      cursor: pointer;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 700;
      font-size: 13px;
      color: var(--ink);
      background: #f7f9ff;
      border-bottom: 1px solid var(--line);
    }

    .perm-accordion summary::-webkit-details-marker{ display:none; }

    .perm-accordion[open] summary{
      background: #eef2ff;
    }

    .perm-meta{
      font-size: 11px;
      color: var(--muted);
      font-weight: 600;
    }

    .perm-chevron{
      width: 18px;
      height: 18px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--line);
      background: #ffffff;
      transition: transform 0.2s ease;
    }

    .perm-accordion[open] .perm-chevron{
      transform: rotate(180deg);
    }

    .perm-body{
      padding: 10px 14px 12px;
    }

    .status-chip{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #ffffff;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 14px;
    }

    .status-dot{
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #cbd5f5;
    }

    .status-chip.is-active{
      color: var(--ink);
      border-color: rgba(91,124,250,0.25);
      background: rgba(91,124,250,0.08);
    }

    .status-chip.is-active .status-dot{
      background: var(--accent);
    }

    /* Mobile Mode Toggle */
    .mobile-toggle{
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 1000;
      padding: 8px 14px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .mobile-toggle:hover{
      background: #4a6be8;
    }

    /* Mobile Mode Styles */
    body.mobile-mode .layout{
      grid-template-columns: 1fr;
    }
    body.mobile-mode .sidebar{
      position: fixed;
      left: -280px;
      top: 0;
      bottom: 0;
      width: 280px;
      z-index: 999;
      transition: left 0.3s ease;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    body.mobile-mode .sidebar.is-open{
      left: 0;
    }
    body.mobile-mode .mobile-overlay{
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 998;
      display: none;
    }
    body.mobile-mode .mobile-overlay.is-visible{
      display: block;
    }
    body.mobile-mode .hamburger{
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 997;
      padding: 10px 14px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    body.mobile-mode .hamburger:hover{
      background: #4a6be8;
    }

    /* Mobile-friendly form controls */
    body.mobile-mode .btn,
    body.mobile-mode .control{
      min-height: 44px;
      font-size: 15px;
    }
    body.mobile-mode .section{
      padding: 16px;
    }
    body.mobile-mode .field label{
      font-size: 14px;
    }

    /* Mobile-friendly audit table */
    body.mobile-mode #auditLogsTable table{
      font-size: 12px;
    }
    body.mobile-mode #auditLogsTable th,
    body.mobile-mode #auditLogsTable td{
      padding: 8px 6px;
    }
    body.mobile-mode #auditLogsTable th:nth-child(1),
    body.mobile-mode #auditLogsTable td:nth-child(1){
      font-size: 11px;
    }
    @media (max-width: 640px) {
      #auditLogsTable table{
        font-size: 11px;
      }
      #auditLogsTable th,
      #auditLogsTable td{
        padding: 6px 4px;
      }
      #auditLogsTable th:nth-child(4),
      #auditLogsTable td:nth-child(4){
        display: none; /* Hide target column on very small screens */
      }
    }
    body.mobile-mode .actions{
      flex-direction: column;
    }
    body.mobile-mode .actions .btn{
      width: 100%;
    }
    body.mobile-mode .row{
      grid-template-columns: 1fr;
      gap: 12px;
    }
    body.mobile-mode .subtabs{
      flex-wrap: wrap;
    }

    @media (max-width: 900px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{
        position: sticky;
        top: 0;
        z-index: 2;
      }
      .nav{
        flex-direction: row;
        flex-wrap: wrap;
      }
      .row{ grid-template-columns: 1fr; }
    }
    @media (max-width: 768px){
      body:not(.mobile-mode) .mobile-toggle::after{
        content: ' (Auto)';
        opacity: 0.8;
      }
    }
  </style>
</head>
<body>
  <button id="mobileToggle" class="mobile-toggle" type="button" title="Toggle mobile-friendly mode">
    <span id="mobileToggleIcon">üì±</span>
    <span id="mobileToggleText">Mobile Mode</span>
  </button>
  <button id="hamburger" class="hamburger" type="button" style="display:none;" title="Open menu">
    ‚ò∞
  </button>
  <div class="mobile-overlay" id="mobileOverlay"></div>
  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="brand">Admin Console</div>
      <div class="subbrand">Calpe Ward - Control Panel</div>
      <div id="adminUserStatus" class="status-chip">
        <span class="status-dot"></span>
        <span>Not signed in</span>
      </div>
      <button id="viewAsBtn" class="btn" type="button" style="margin: 10px 0; display:none;">üëÅ View As</button>

      <nav class="nav">
        <a class="is-active" data-panel="overview" href="#overview">Status</a>
        <a data-panel="users" href="#users">User Management</a>
        <a data-panel="leave-management" href="#leave-management">Annual Leave</a>
        <a data-panel="bank-holidays" href="#bank-holidays">Bank Holidays</a>
        <a data-panel="permissions" href="#permissions">Permissions</a>
        <a data-panel="patterns" href="#patterns">Patterns</a>
        <a data-panel="rota-periods" href="#rota-periods">Rota Periods</a>
        <a data-panel="notices" href="#notices">Notices</a>
        <a data-panel="shift-swaps" href="#shift-swaps">Shift Swaps</a>
        <a data-panel="shift-catalogue" href="#shift-catalogue">Shift Catalogue</a>
        <a data-panel="staffing" href="#staffing">Staffing Defaults</a>
        <a data-panel="available-shifts" href="#available-shifts">Available Shifts</a>
        <a data-panel="audit" href="#audit">Audit</a>
        <a href="preview.html">üìä Preview Generator</a>
      </nav>
    </aside>

    <main class="main">
      <h1 class="page-title">Admin Control Panel</h1>
      <p class="page-subtitle">Structured, audit-safe administration for rota and requests.</p>

      <div class="grid">
        <section id="overview" class="section panel">
          <h2>Status Dashboard</h2>
          <p>Real-time snapshot of current period, publishing, and staffing.</p>
          
          <!-- CURRENT PERIOD SECTION -->
          <div style="border-top:2px solid #e0e0e0; padding-top:12px; margin-top:12px;">
            <h3 style="margin:0 0 12px 0; font-size:14px; color:var(--dim); text-transform:uppercase; font-weight:600;">
              Current Period
            </h3>
            
            <!-- Period & Publishing Status -->
            <div class="row" style="gap:12px; margin-top:12px;">
              <div class="field" style="background:#f5f5f5; padding:12px; border-radius:8px; flex:1;">
                <h3 style="margin:0 0 4px 0; font-size:13px; color:var(--dim);">PERIOD</h3>
                <p id="statusPeriodText" style="margin:0; font-size:14px; font-weight:600;">Loading...</p>
                <div id="statusPeriodProgress" style="width:100%; height:4px; background:#e0e0e0; border-radius:2px; margin-top:8px; overflow:hidden;">
                  <div style="width:45%; height:100%; background:#2ecc71; border-radius:2px;"></div>
                </div>
              </div>
              <div class="field" style="background:#f5f5f5; padding:12px; border-radius:8px; flex:1;">
                <h3 style="margin:0 0 4px 0; font-size:13px; color:var(--dim);">STATUS</h3>
                <p id="statusDraftText" style="margin:0; font-size:14px; font-weight:600;">
                  <span id="draftBadge" style="display:inline-block; padding:2px 8px; border-radius:4px; font-size:12px; background:#fff3cd; color:#856404;">Loading</span>
                </p>
              </div>
            </div>

            <!-- Requests & Staffing -->
            <div class="row" style="gap:12px; margin-top:12px;">
              <div class="field" style="background:#f5f5f5; padding:12px; border-radius:8px; flex:1;">
                <h3 style="margin:0 0 4px 0; font-size:13px; color:var(--dim);">REQUESTS WINDOW</h3>
                <p id="statusRequestsText" style="margin:0; font-size:14px; font-weight:600;">Loading...</p>
                <div style="font-size:12px; color:var(--dim); margin-top:4px;">
                  <span id="daysUntilClose" style="font-weight:600;">-</span> days remaining
                </div>
              </div>
              <div class="field" style="background:#f5f5f5; padding:12px; border-radius:8px; flex:1;">
                <h3 style="margin:0 0 4px 0; font-size:13px; color:var(--dim);">COVERAGE</h3>
                <p id="statusCoverageText" style="margin:0; font-size:14px; font-weight:600;">Loading...</p>
                <div id="statusCoverageProgress" style="width:100%; height:4px; background:#e0e0e0; border-radius:2px; margin-top:8px; overflow:hidden;">
                  <div id="coverageBar" style="width:0%; height:100%; background:#3498db; border-radius:2px;"></div>
                </div>
              </div>
            </div>

            <!-- Quick Stats Cards -->
            <div class="row" style="gap:12px; margin-top:12px;">
              <div class="field" style="background:#e8f4f8; padding:12px; border-radius:8px; flex:1; border-left:4px solid #3498db;">
                <h3 style="margin:0 0 4px 0; font-size:13px; color:var(--dim);">SWAP REQUESTS</h3>
                <p style="margin:0; font-size:18px; font-weight:700; color:#3498db;" id="swapCount">-</p>
                <p style="margin:4px 0 0 0; font-size:12px; color:var(--dim);">pending approval</p>
              </div>
              <div class="field" style="background:#fef5e7; padding:12px; border-radius:8px; flex:1; border-left:4px solid #f39c12;">
                <h3 style="margin:0 0 4px 0; font-size:13px; color:var(--dim);">TIME-OFF REQUESTS</h3>
                <p style="margin:0; font-size:18px; font-weight:700; color:#f39c12;" id="timeoffCount">-</p>
                <p style="margin:4px 0 0 0; font-size:12px; color:var(--dim);">awaiting decision</p>
              </div>
              <div class="field" style="background:#eafaf1; padding:12px; border-radius:8px; flex:1; border-left:4px solid #27ae60;">
                <h3 style="margin:0 0 4px 0; font-size:13px; color:var(--dim);">TOTAL STAFF</h3>
                <p style="margin:0; font-size:18px; font-weight:700; color:#27ae60;" id="staffCount">-</p>
                <p style="margin:4px 0 0 0; font-size:12px; color:var(--dim);">active this period</p>
              </div>
            </div>

            <!-- Alerts Section -->
            <div id="statusAlerts" style="margin-top:12px; display:none;">
              <h4 style="margin:0 0 8px 0; font-size:12px; color:var(--dim); text-transform:uppercase; font-weight:600;">Alerts</h4>
              <div id="alertsList" style="display:flex; flex-direction:column; gap:6px;"></div>
            </div>

            <!-- Quick Actions -->
            <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
              <button class="btn" id="quickPublishBtn" type="button" style="font-size:13px;">Publish Period</button>
              <button class="btn" id="quickSwapsBtn" type="button" style="font-size:13px;">View Swaps</button>
              <button class="btn" id="quickTimeoffBtn" type="button" style="font-size:13px;">View Time-Off</button>
            </div>
          </div>

          <!-- PREVIOUS PERIOD (COLLAPSIBLE) -->
          <div style="border-top:2px solid #e0e0e0; padding-top:12px; margin-top:12px;">
            <button id="prevPeriodToggle" type="button" style="
              background:none;
              border:none;
              padding:0;
              cursor:pointer;
              display:flex;
              align-items:center;
              gap:8px;
              font-size:14px;
              font-weight:600;
              color:var(--dim);
              text-transform:uppercase;
              width:100%;
              justify-content:space-between;
            ">
              <span>Previous Period</span>
              <span id="prevPeriodToggleIcon" style="font-size:12px; transition:transform 0.2s;">‚ñ∂</span>
            </button>
            
            <div id="prevPeriodContent" style="display:none; margin-top:12px;">
              <!-- Previous Period & Publishing Status -->
              <div class="row" style="gap:12px; margin-top:12px;">
                <div class="field" style="background:#f9f9f9; padding:12px; border-radius:8px; flex:1;">
                  <h3 style="margin:0 0 4px 0; font-size:13px; color:var(--dim);">PERIOD</h3>
                  <p id="prevPeriodText" style="margin:0; font-size:14px; font-weight:600;">No previous period</p>
                </div>
                <div class="field" style="background:#f9f9f9; padding:12px; border-radius:8px; flex:1;">
                  <h3 style="margin:0 0 4px 0; font-size:13px; color:var(--dim);">STATUS</h3>
                  <p id="prevStatusText" style="margin:0; font-size:14px; font-weight:600;">
                    <span id="prevDraftBadge" style="display:inline-block; padding:2px 8px; border-radius:4px; font-size:12px; background:#e0e0e0; color:#666;">-</span>
                  </p>
                </div>
              </div>

              <!-- Previous Period Stats -->
              <div class="row" style="gap:12px; margin-top:12px;">
                <div class="field" style="background:#f9f9f9; padding:12px; border-radius:8px; flex:1; border-left:4px solid #bbb;">
                  <h3 style="margin:0 0 4px 0; font-size:13px; color:var(--dim);">COVERAGE</h3>
                  <p style="margin:0; font-size:16px; font-weight:700; color:#666;" id="prevCoverageText">-</p>
                </div>
                <div class="field" style="background:#f9f9f9; padding:12px; border-radius:8px; flex:1; border-left:4px solid #bbb;">
                  <h3 style="margin:0 0 4px 0; font-size:13px; color:var(--dim);">TOTAL STAFF</h3>
                  <p style="margin:0; font-size:16px; font-weight:700; color:#666;" id="prevStaffCount">-</p>
                </div>
                <div class="field" style="background:#f9f9f9; padding:12px; border-radius:8px; flex:1; border-left:4px solid #bbb;">
                  <h3 style="margin:0 0 4px 0; font-size:13px; color:var(--dim);">COMPLETED</h3>
                  <p style="margin:0; font-size:16px; font-weight:700; color:#27ae60;" id="prevCompletedText">-</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="non-staff" class="section panel" style="display:none;">
          <h2>Non-Staff Profiles</h2>
          <p>Create, edit, activate/deactivate non-staff profiles (students, bank, agency).</p>

          <div class="subtabs" role="tablist" aria-label="Non-staff management pages">
            <button class="subtab is-active" data-ns-page="view" type="button">View profiles</button>
            <button class="subtab" data-ns-page="add" type="button">Add profile</button>
            <button class="subtab" data-ns-page="edit" type="button">Edit profile</button>
          </div>

          <!-- View -->
          <div id="nsPageView" class="ns-page">
            <div class="accordion-sub">Search and manage non-staff profiles.</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top:10px;">
              <div style="font-weight:700;">Profiles</div>
              <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; color:var(--muted);">
                <input type="checkbox" id="nsShowInactive" />
                Show inactive
              </label>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
              <input id="nsSearchInput" class="control" placeholder="Search name..." />
              <select id="nsFilterCategory" class="control" style="min-width:140px;">
                <option value="">All categories</option>
                <option value="student">Student</option>
                <option value="bank">Bank</option>
                <option value="agency">Agency</option>
              </select>
              <select id="nsFilterRole" class="control" style="min-width:160px;">
                <option value="">All role groups</option>
                <option value="staff_nurse">Staff Nurse</option>
                <option value="nursing_assistant">Nursing Assistant</option>
              </select>
              <button id="nsRefreshBtn" class="btn" type="button">Refresh</button>
            </div>
            <div id="nsList" style="margin-top:12px; border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#fff;"></div>
          </div>

          <!-- Add -->
          <div id="nsPageAdd" class="ns-page" style="display:none;">
            <div class="accordion-sub">Create a new non-staff profile.</div>
            <div class="field" style="margin-top:10px;">
              <h3>New profile</h3>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                <input id="nsAddName" class="control" placeholder="Full name" style="flex:1; min-width:200px;" />
                <select id="nsAddCategory" class="control" style="min-width:160px;">
                  <option value="student">Student</option>
                  <option value="bank">Bank</option>
                  <option value="agency">Agency</option>
                </select>
                <span id="nsAddRoleWrap"><select id="nsAddRole" class="control" style="min-width:180px;">
                  <option value="staff_nurse">Staff Nurse</option>
                  <option value="nursing_assistant">Nursing Assistant</option>
                </select></span>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                <input id="nsAddNotes" class="control" placeholder="Notes (optional)" style="flex:1; min-width:280px;" />
                <button id="nsCreateBtn" class="btn primary" type="button">Create</button>
                <button id="nsAddClearBtn" class="btn" type="button">Clear</button>
              </div>
              <div id="nsAddHelp" class="page-subtitle" style="margin-top:8px;"></div>
            </div>
          </div>

          <!-- Edit -->
          <div id="nsPageEdit" class="ns-page" style="display:none;">
            <div class="accordion-sub">Update profile details and status.</div>
            <details class="accordion" open>
              <summary class="accordion-title">Select profile</summary>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                <input id="nsEditSearch" class="control" placeholder="Search profile..." style="flex:1; min-width:200px;" />
                <select id="nsEditSelect" class="control" style="min-width:240px;">
                  <option value="">Select profile...</option>
                </select>
              </div>
            </details>

            <details class="accordion" open>
              <summary class="accordion-title">Identity & Details</summary>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                <input id="nsEditName" class="control" placeholder="Full name" style="flex:1; min-width:200px;" />
                <select id="nsEditCategory" class="control" style="min-width:160px;">
                  <option value="student">Student</option>
                  <option value="bank">Bank</option>
                  <option value="agency">Agency</option>
                </select>
                <span id="nsEditRoleWrap"><select id="nsEditRole" class="control" style="min-width:180px;">
                  <option value="staff_nurse">Staff Nurse</option>
                  <option value="nursing_assistant">Nursing Assistant</option>
                </select></span>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                <input id="nsEditNotes" class="control" placeholder="Notes (optional)" style="flex:1; min-width:280px;" />
                <button id="nsSaveBtn" class="btn primary" type="button">Save</button>
                <button id="nsEditCancelBtn" class="btn" type="button">Cancel</button>
              </div>
              <div id="nsEditHelp" class="page-subtitle" style="margin-top:8px;"></div>
            </details>

            <details class="accordion">
              <summary class="accordion-title">Active Status</summary>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center;">
                <button id="nsToggleActiveBtn" class="btn" type="button">Deactivate</button>
              </div>
            </details>
          </div>
        </section>

        <section id="leave-management" class="section panel" style="display:none;">
          <h2>Annual Leave</h2>
          <p>Assign and manage leave days for staff members during rota periods.</p>

          <!-- Tabs -->
          <div style="display:flex; gap:8px; margin-top:16px; border-bottom:2px solid #e5e7eb;">
            <button id="leaveTabIndividual" class="tab-button active" style="padding:12px 20px; border:none; background:none; cursor:pointer; font-weight:500; color:#3b82f6; border-bottom:2px solid #3b82f6; margin-bottom:-2px;">
              Individual Leave
            </button>
            <button id="leaveTabAnnual" class="tab-button" style="padding:12px 20px; border:none; background:none; cursor:pointer; font-weight:500; color:#6b7280; margin-bottom:-2px;">
              Annual View
            </button>
          </div>

          <!-- Individual Leave Tab -->
          <div id="leaveTabIndividualContent" style="display:block; margin-top:16px;">
            <div class="field">
              <label style="font-size:12px; color:var(--muted); font-weight:500;">Select User</label>
              <select id="leaveUserSelect" class="control" style="max-width:300px; margin-top:4px;">
                <option value="">-- Select a user --</option>
              </select>
            </div>

            <div id="leaveUserDetails" style="display:none; margin-top:24px;">
              <div class="card" style="padding:16px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px;">
                <h3 style="margin:0 0 12px 0; font-size:16px; color:#1f2937;">
                  <span id="leaveUserName">User Name</span> - Leave Summary
                </h3>
                
                <div style="display:grid; grid-template-columns: 1fr; gap:12px; margin-bottom:16px;">
                  <div style="padding:12px; background:white; border-radius:6px; border:1px solid #d1d5db;">
                    <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">Total Leave Days Assigned</div>
                    <div style="font-size:24px; font-weight:700; color:#3b82f6;" id="leaveTotalDays">0</div>
                  </div>
                </div>

                <div style="margin-top:20px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h4 style="margin:0; font-size:14px; color:#374151;">Assigned Leave Entries</h4>
                    <button id="leaveAddBtn" class="btn primary" type="button" style="padding:8px 16px; font-size:14px;">+ Add Leave</button>
                  </div>
                  
                  <div id="leaveEntriesList" style="max-height:400px; overflow-y:auto;">
                    <p style="text-align:center; color:#9ca3af; padding:40px 0;">No leave entries assigned yet.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Annual View Tab -->
          <div id="leaveTabAnnualContent" style="display:none; margin-top:16px;">
            <div id="leaveAnnualView" style="overflow-x:auto; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:20px; background:white;">
            </div>
          </div>
        </section>

        <section id="bank-holidays" class="section panel" style="display:none;">
          <h2>Bank Holidays</h2>
          <p>Manage bank holidays displayed on the rota (by year).</p>

          <div class="field" style="margin-top:10px;">
            <label style="font-size:12px; color:var(--muted); font-weight:500;">Year</label>
            <select id="bhYear" class="control" style="max-width:160px; margin-top:4px;">
              <option value="2026">2026</option>
              <option value="2027">2027</option>
              <option value="2028">2028</option>
              <option value="2029">2029</option>
              <option value="2030">2030</option>
            </select>
          </div>

          <div class="field" style="margin-top:16px;">
            <h3>Add Bank Holiday</h3>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <input id="bhDate" type="date" class="control" style="min-width:140px;" />
              <input id="bhName" class="control" placeholder="Holiday name (e.g., Christmas Day)" style="flex:1; min-width:200px;" />
              <button id="bhAddBtn" class="btn primary" type="button">Add</button>
            </div>
            <div id="bhAddHelp" class="page-subtitle" style="margin-top:8px;"></div>
          </div>

          <div style="margin-top:16px; border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#fff;">
            <div style="background:var(--header); padding:12px; font-weight:600; font-size:13px;">Bank Holidays</div>
            <div id="bhList" style="max-height:400px; overflow-y:auto;"></div>
          </div>
        </section>

        <section id="users" class="section panel" style="display:none;">
          <h2>User Management</h2>
          <p>Manage staff users, status, patterns, and permission groups.</p>

          <div id="adminUserAuthNotice" class="field" style="display:none; margin-bottom:12px;">
            <h3>Admin access required</h3>
            <p>Sign in with your name and PIN to access admin tools.</p>
          </div>

          <div class="subtabs" role="tablist" aria-label="User management pages">
            <button class="subtab is-active" data-users-page="view" type="button">View users</button>
            <button class="subtab" data-users-page="add" type="button">Add user</button>
            <button class="subtab" data-users-page="edit" type="button">Edit user</button>
          </div>

          <div id="usersPageView" class="users-page">
            <div class="accordion-sub">Search and review staff within groups.</div>
            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top:10px;">
              <div style="font-weight:700;">Users</div>
              <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; color:var(--muted);">
                <input type="checkbox" id="adminShowInactiveUsers" />
                Show inactive
              </label>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
              <input id="adminUserSearch" class="control" placeholder="Search name..." />
              <button id="adminAddUserBtn" class="btn primary" type="button">Add user</button>
            </div>
            <div id="adminUsersList" style="margin-top:12px; border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#fff;"></div>
          </div>

          <div id="usersPageAdd" class="users-page" style="display:none;">
            <div class="accordion-sub">Create a new user record.</div>
            <div id="adminUserAddSection" class="field" style="margin-top:10px;">
              <h3>New user</h3>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                <input id="adminAddUserName" class="control" placeholder="Name" style="flex:1; min-width:180px;" />
                <select id="adminAddUserRole" class="control" style="min-width:160px;">
                  <option value="1">Charge Nurse</option>
                  <option value="2">Staff Nurse</option>
                  <option value="3">Nursing Assistant</option>
                </select>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
                <input id="adminAddUserPin" class="control" placeholder="PIN (4 digits)" inputmode="numeric" maxlength="4" style="flex:1; min-width:180px;" />
                <button id="adminCreateUserBtn" class="btn primary" type="button">Create</button>
                <button id="adminAddUserCancelBtn" class="btn" type="button">Clear</button>
              </div>
              <div id="adminUserAddHelp" class="page-subtitle" style="margin-top:8px;"></div>
            </div>
          </div>

          <div id="usersPageEdit" class="users-page" style="display:none;">
            
            <!-- User Header with Role Badge -->
            <div style="margin-bottom:24px; padding-bottom:16px; border-bottom:2px solid #e5e7eb;">
              <div style="display:flex; align-items:center; gap:12px;">
                <h2 id="editUserPageTitle" style="margin:0; font-size:28px; font-weight:700; color:#1f2937;">User Name</h2>
                <span id="editUserRoleBadge" style="display:inline-block; padding:6px 14px; background:#3b82f6; color:white; border-radius:20px; font-size:12px; font-weight:600;">Charge Nurse</span>
              </div>
            </div>

            <!-- Identity & PIN Card -->
            <div style="border:1px solid #e5e7eb; border-radius:10px; background:#ffffff; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,0.08); margin-bottom:14px;">
              <div style="font-size:14px; font-weight:600; padding:14px; background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                ü™™ Identity & PIN
              </div>
              <div style="padding:16px;">
                <div style="display:flex; gap:12px; flex-direction:column;">
                  <div>
                    <label style="display:block; font-size:12px; font-weight:600; color:#374151; margin-bottom:6px;">Name</label>
                    <input id="adminEditUserName" class="control" placeholder="Name" style="width:100%; font-size:13px; padding:9px 12px; border:1px solid #d1d5db; border-radius:7px;" />
                  </div>
                  <div>
                    <label style="display:block; font-size:12px; font-weight:600; color:#374151; margin-bottom:6px;">Role</label>
                    <select id="adminEditUserRole" class="control" style="width:100%; font-size:13px; padding:9px 12px; border:1px solid #d1d5db; border-radius:7px;">
                      <option value="1">Charge Nurse</option>
                      <option value="2">Staff Nurse</option>
                      <option value="3">Nursing Assistant</option>
                    </select>
                  </div>
                  <div>
                    <label style="display:block; font-size:12px; font-weight:600; color:#374151; margin-bottom:6px;">New PIN (4 digits)</label>
                    <input id="adminEditUserPin" class="control" placeholder="Leave blank to keep" inputmode="numeric" maxlength="4" style="width:100%; font-size:13px; padding:9px 12px; border:1px solid #d1d5db; border-radius:7px;" />
                    <div style="font-size:11px; color:#6b7280; margin-top:5px;" id="adminUserEditHelp"></div>
                  </div>
                </div>
                <div style="display:flex; gap:8px; margin-top:14px;">
                  <button id="adminCancelUserEditBtn" class="btn" type="button" style="flex:1; font-size:12px; padding:9px 12px;">Cancel</button>
                  <button id="adminSaveUserPinBtn" class="btn primary" type="button" style="flex:1; font-size:12px; padding:9px 12px;">üíæ Save PIN</button>
                </div>
              </div>
            </div>

            <!-- Secondary Row: Pattern & Permission Groups (Compact - Open by default) -->
            <div class="edit-user-two-col">
              
              <!-- Pattern Card -->
              <details class="accordion edit-user-card" open>
                <summary class="accordion-title" style="font-size:13px; font-weight:600; padding:12px; background:#f9fafb; border-bottom:1px solid #e5e7eb; cursor:pointer; user-select:none; list-style:none;">
                  üìÖ Pattern
                </summary>
                <div class="edit-user-card-body">
                  <div style="margin-bottom:10px;">
                    <label style="display:block; font-size:11px; font-weight:600; color:#374151; margin-bottom:5px;">Pattern Type</label>
                    <select id="adminUserPattern" class="control" style="width:100%; font-size:12px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px;">
                      <option value="">No fixed pattern</option>
                    </select>
                  </div>
                  <div>
                    <label style="display:block; font-size:11px; font-weight:600; color:#374151; margin-bottom:5px;">Anchor Date (Sunday)</label>
                    <input id="adminUserAnchorDate" class="control" type="date" style="width:100%; font-size:12px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px;" />
                  </div>
                </div>
              </details>

              <!-- Permission Groups Card -->
              <details class="accordion edit-user-card" open>
                <summary class="accordion-title" style="font-size:13px; font-weight:600; padding:12px; background:#f9fafb; border-bottom:1px solid #e5e7eb; cursor:pointer; user-select:none; list-style:none;">
                  üë• Permission Groups
                </summary>
                <div class="edit-user-card-body">
                  <div id="adminUserPermissionGroups"></div>
                </div>
              </details>
            </div>

            <!-- Annual Leave (Full Width - Open by default) -->
            <details class="accordion" open style="border:1px solid #e5e7eb; border-radius:10px; background:#ffffff; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,0.08); margin-bottom:14px;">
              <summary class="accordion-title" style="font-size:14px; font-weight:600; padding:14px; background:#f9fafb; border-bottom:1px solid #e5e7eb; cursor:pointer; user-select:none; list-style:none;">
                üèñÔ∏è Annual Leave
              </summary>
            <div style="padding:16px;">
              
              <!-- Leave Balance Cards (RN/SN only) -->
              <div id="editUserLeaveBalanceSection" style="display:none;">
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:16px; margin-bottom:20px;">
                  <h4 style="margin:0 0 14px 0; font-size:14px; font-weight:700; color:#1e293b;">
                    üìä Annual Leave Entitlement (<span id="balanceYear">2026</span>)
                  </h4>
                  
                  <div id="editUserLeaveBalanceCards" style="margin-bottom:16px;">
                    <!-- Cards populated by JS -->
                  </div>

                  <!-- Base Entitlement Editor -->
                  <div style="background:#ffffff; border:1px solid #e2e8f0; border-radius:8px; padding:14px; margin-bottom:16px;">
                    <div style="font-size:12px; font-weight:600; color:#64748b; margin-bottom:10px;">Base Entitlement Settings</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:end;">
                      <div>
                        <label style="display:block; font-size:11px; font-weight:600; color:#64748b; margin-bottom:5px;">
                          Annual Days
                        </label>
                        <input type="number" id="editUserLeaveEntitlementDays" min="0" max="50" step="0.5" 
                          style="width:100%; padding:7px 10px; border:1px solid #cbd5e1; border-radius:6px; font-size:13px;" />
                      </div>
                      
                      <div>
                        <label style="display:block; font-size:11px; font-weight:600; color:#64748b; margin-bottom:5px;">
                          Year
                        </label>
                        <input type="number" id="editUserLeaveYear" min="2020" max="2100" 
                          style="width:100%; padding:7px 10px; border:1px solid #cbd5e1; border-radius:6px; font-size:13px;" />
                      </div>

                      <button id="editUserSaveLeaveEntitlementBtn" class="btn" type="button" style="padding:7px 14px; font-size:12px; height:34px;">
                        üíæ Save
                      </button>
                    </div>
                  </div>

                  <!-- Adjustments Section -->
                  <div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                      <div style="font-size:12px; font-weight:600; color:#64748b;">üìù Adjustments History</div>
                      <button id="addLeaveAdjustmentBtn" class="btn" type="button" style="padding:5px 10px; font-size:11px;">
                        + Add
                      </button>
                    </div>
                    <div id="leaveAdjustmentsList" style="min-height:40px;">
                      <!-- Populated by JS -->
                    </div>
                  </div>
                </div>
              </div>

              <!-- Leave Entries Summary (All staff) -->
              <div style="background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; padding:16px;">
                <h4 style="margin:0 0 12px 0; font-size:14px; font-weight:700; color:#1e293b;">
                  Leave Taken (<span id="leaveSummaryYear">Current Year</span>)
                </h4>

                <div style="display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:14px;">
                  <div style="padding:12px; background:#ecfdf5; border:1px solid #6ee7b7; border-radius:8px;">
                    <div style="font-size:11px; color:#065f46; margin-bottom:4px; font-weight:600;">Total Days</div>
                    <div style="font-size:22px; font-weight:700; color:#059669;" id="editUserTotalLeaveDays">--</div>
                  </div>
                </div>
                
                <div id="editUserLeaveEntriesList" style="max-height:240px; overflow-y:auto; margin-bottom:12px; padding:2px;">
                  <p style="text-align:center; color:#9ca3af; padding:20px 0; font-size:13px;">No leave entries.</p>
                </div>
                
                <button id="editUserManageLeaveBtn" class="btn" type="button" style="width:100%; font-size:13px;">
                  Open Leave Management Panel ‚Üí
                </button>
              </div>
            </div>
            </details>

            <!-- Preferences & Capabilities Card (Collapsed by default) -->
            <details class="accordion" style="border:1px solid #e5e7eb; border-radius:10px; background:#ffffff; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,0.08); margin-bottom:14px;">
              <summary class="accordion-title" style="font-size:14px; font-weight:600; padding:14px; background:#f9fafb; border-bottom:1px solid #e5e7eb; cursor:pointer; user-select:none; list-style:none;">
                ‚öôÔ∏è Preferences & Capabilities
              </summary>
              <div style="padding:16px;">
                <div style="margin-bottom:14px;">
                  <div style="font-size:11px; color:#6b7280; margin-bottom:12px; line-height:1.5;">1=avoid ‚Ä¢ 3=neutral ‚Ä¢ 5=keen</div>
                  
                  <div style="margin-bottom:10px;">
                    <label style="display:flex; justify-content:space-between; align-items:center; gap:8px; font-size:12px; font-weight:600; color:#374151; margin-bottom:5px;">
                      <span>Shift Clustering</span>
                      <span id="adminPrefShiftClusteringValue" style="font-weight:700; color:#3b82f6;">3</span>
                    </label>
                    <input id="adminPrefShiftClustering" class="control" type="range" min="1" max="5" step="1" value="3" style="width:100%;" />
                  </div>

                  <div style="margin-bottom:10px;">
                    <label style="display:flex; justify-content:space-between; align-items:center; gap:8px; font-size:12px; font-weight:600; color:#374151; margin-bottom:5px;">
                      <span>Night Appetite</span>
                      <span id="adminPrefNightAppetiteValue" style="font-weight:700; color:#3b82f6;">3</span>
                    </label>
                    <input id="adminPrefNightAppetite" class="control" type="range" min="1" max="5" step="1" value="3" style="width:100%;" />
                  </div>

                  <div style="margin-bottom:10px;">
                    <label style="display:flex; justify-content:space-between; align-items:center; gap:8px; font-size:12px; font-weight:600; color:#374151; margin-bottom:5px;">
                      <span>Weekend Appetite</span>
                      <span id="adminPrefWeekendAppetiteValue" style="font-weight:700; color:#3b82f6;">3</span>
                    </label>
                    <input id="adminPrefWeekendAppetite" class="control" type="range" min="1" max="5" step="1" value="3" style="width:100%;" />
                  </div>

                  <div style="margin-bottom:14px;">
                    <label style="display:flex; justify-content:space-between; align-items:center; gap:8px; font-size:12px; font-weight:600; color:#374151; margin-bottom:5px;">
                      <span>Leave Adjacency</span>
                      <span id="adminPrefLeaveAdjacencyValue" style="font-weight:700; color:#3b82f6;">3</span>
                    </label>
                    <input id="adminPrefLeaveAdjacency" class="control" type="range" min="1" max="5" step="1" value="3" style="width:100%;" />
                  </div>
                </div>

                <div style="padding:10px; background:#f3f4f6; border-radius:7px; margin-bottom:14px;">
                  <div style="font-size:12px; font-weight:600; color:#374151; margin-bottom:8px;">Capabilities</div>
                  <label style="display:flex; align-items:center; gap:8px; font-size:11px; margin-bottom:6px;">
                    <input type="checkbox" id="adminCanBeInChargeDay" />
                    <span>Can be in charge (day)</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:8px; font-size:11px; margin-bottom:6px;">
                    <input type="checkbox" id="adminCanBeInChargeNight" />
                    <span>Can be in charge (night)</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:8px; font-size:11px; margin-bottom:6px;">
                    <input type="checkbox" id="adminCannotBeSecondDay" />
                    <span>Not 2nd RN (day)</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:8px; font-size:11px; margin-bottom:6px;">
                    <input type="checkbox" id="adminCannotBeSecondNight" />
                    <span>Not 2nd RN (night)</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:8px; font-size:11px;">
                    <input type="checkbox" id="adminCanWorkNights" checked />
                    <span>Can work nights</span>
                  </label>
                </div>
                <div id="adminPrefsHelp" class="page-subtitle" style="font-size:11px;"></div>
              </div>
            </details>
        </section>

        <section id="reorder" class="section panel" style="display:none;">
          <h2>Reorder rota</h2>
          <p>Drag users within each group to set the display order for rota views.</p>
          <div id="adminUsersReorderList" class="reorder-list" style="margin-top:12px; border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#fff;"></div>
        </section>

        <section id="permissions" class="section panel" style="display:none;">
          <h2>Permissions</h2>
          <p>Define permission groups and attach capabilities (superadmin bypass via is_admin).</p>
          <div class="field" style="margin-bottom:12px;">
            <h3>Permission groups</h3>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <select id="permissionGroupSelect" class="control" style="max-width:240px;">
                <option value="">Select group...</option>
              </select>
              <input id="permissionGroupName" class="control" placeholder="New group name..." style="max-width:240px;" />
              <button id="createPermissionGroupBtn" class="btn" type="button">Create group</button>
            </div>
            <div id="permissionGroupHelp" class="page-subtitle" style="margin-top:8px;">
              Admin group can be assigned by admins, but only superadmin can edit its permissions.
            </div>
          </div>
          <div id="permissionsMatrix"></div>
        </section>

        <section id="rota-periods" class="section panel" style="display:none;">
          <h2>Rota Periods</h2>
          <p>Create, activate, close, or hide periods. Manage week open/close state.</p>

          <div class="subtabs" role="tablist" aria-label="Period management pages">
            <button class="subtab is-active" data-periods-page="manage" type="button">Manage Periods</button>
            <button class="subtab" data-periods-page="generate" type="button">Generate New Period</button>
          </div>

          <!-- Manage Periods Page -->
          <div id="periodsPageManage" class="periods-page">
            <!-- Period picker -->
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:16px; margin-top:16px;">
              <div style="font-weight:700;">Select Period</div>
              <select id="adminPeriodSelect" class="control" style="min-width:220px; flex: 0 0 auto;"></select>
              <div class="page-subtitle" id="adminPeriodMeta"></div>
            </div>

            <!-- Period Actions -->
            <div style="border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:16px; background:#fff;">
              <div style="font-weight:700; margin-bottom:10px;">Period Actions</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button id="adminSetActiveBtn" type="button" class="btn">Set Active</button>
                <button id="adminToggleHiddenBtn" type="button" class="btn">Toggle Hidden</button>
              </div>
            </div>

            <!-- Requests close time -->
            <div style="border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:16px; background:#fff;">
              <div style="font-weight:700; margin-bottom:10px;">Requests Closing Time</div>
              
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
                <input id="adminClosesAtInput" type="datetime-local" class="control" style="flex: 1; min-width:200px;" />
                <button id="adminClosesAtSaveBtn" type="button" class="btn primary">Save Close Time</button>
                <button id="adminClosesAtClearBtn" type="button" class="btn">Clear</button>
              </div>
              
              <div class="page-subtitle" id="adminClosesAtHelp">
                Set when requests will lock for this whole 5-week period. All weeks will be closed after this time.
              </div>
            </div>

            <!-- Weeks list -->
            <div style="border:1px solid var(--line); border-radius:14px; padding:14px; background:#fff;">
              <div style="font-weight:700; margin-bottom:10px;">Weeks Management</div>
              <div class="page-subtitle" style="margin-bottom:10px;">Open or close individual weeks for staff requests.</div>
              <div id="adminWeeksList">Select a period to view weeks...</div>
            </div>
          </div>

          <!-- Generate Period Page -->
          <div id="periodsPageGenerate" class="periods-page" style="display:none;">
            <div style="border:1px solid var(--line); border-radius:14px; padding:14px; margin-top:16px; background:#fff;">
              <div style="font-weight:700; margin-bottom:10px;">Generate Next 5-Week Period</div>
              <div class="page-subtitle" id="adminGeneratePreview" style="margin-bottom:12px;">Preview will appear here.</div>
              <div id="adminGenerateFutureList" style="font-size:13px; line-height:1.5; color:var(--muted); margin-bottom:12px; border-top:1px solid var(--line); padding-top:10px;">
                Future periods will appear here.
              </div>
              <button id="adminGenerateBtn" class="btn primary" type="button">Generate New Period</button>
            </div>
          </div>
        </section>

        <section id="notices" class="section panel" style="display:none;">
          <h2>Notices</h2>
          <p>Staff-facing notices with acknowledgements.</p>

          <div class="subtabs" role="tablist" aria-label="Notices management pages">
            <button class="subtab is-active" data-notices-page="view" type="button">View notices</button>
            <button class="subtab" data-notices-page="edit" type="button">Create/Edit notice</button>
          </div>

          <!-- View Notices Page -->
          <div id="noticesPageView" class="notices-page">
            <div class="accordion-sub">Search and manage staff notices.</div>
            <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top:10px;">
              <div style="font-weight:700;">All Notices</div>
              <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; color:var(--muted);">
                <input type="checkbox" id="adminShowInactiveNotices" />
                Show inactive
              </label>
            </div>
            
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
              <input id="adminNoticeSearch" class="control" placeholder="Search notices..." style="flex:1; min-width:180px;" />
              <button id="adminNewNoticeBtn" class="btn primary" type="button">New Notice</button>
            </div>
            
            <div id="adminNoticesList" style="border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#fff;"></div>
          </div>

          <!-- Create/Edit Notice Page -->
          <div id="noticesPageEdit" class="notices-page" style="display:none;">
            <div class="accordion-sub">Create or edit a notice.</div>
            
            <div class="field" style="margin-top:16px; margin-bottom:16px;">
              <label style="display:block; margin-bottom:4px; font-weight:600;">Title</label>
              <input id="adminNoticeTitleInput" class="control" placeholder="Notice title" />
            </div>
            
            <div class="field" style="margin-bottom:16px;">
              <label style="display:block; margin-bottom:4px; font-weight:600;">Visibility</label>
              <label style="display:flex; gap:6px; align-items:center; font-size:13px; margin-bottom:6px;">
                <input type="checkbox" id="noticeTargetAll" checked />
                All staff
              </label>
              <div style="margin-left:18px; display:flex; flex-direction:column; gap:4px;">
                <label style="display:flex; gap:6px; align-items:center; font-size:13px;">
                  <input type="checkbox" class="notice-role-chk" value="1" />
                  Charge Nurses
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:13px;">
                  <input type="checkbox" class="notice-role-chk" value="2" />
                  Staff Nurses
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:13px;">
                  <input type="checkbox" class="notice-role-chk" value="3" />
                  Nursing Assistants
                </label>
              </div>
            </div>
            
            <div class="field" style="margin-bottom:16px;">
              <label style="display:block; margin-bottom:4px; font-weight:600;">Body (English)</label>
              <div id="quillEnglish" style="height:200px; border:1px solid #d1d5db; border-radius:6px;"></div>
            </div>
            
            <div class="field" style="margin-bottom:16px;">
              <label style="display:block; margin-bottom:4px; font-weight:600;">Body (Spanish)</label>
              <div id="quillSpanish" style="height:200px; border:1px solid #d1d5db; border-radius:6px;"></div>
            </div>
            
            <div style="display:flex; gap:8px; justify-content:flex-start;">
              <button id="adminNoticeSave" type="button" class="btn primary">Save Notice</button>
              <button id="adminNoticeCancel" type="button" class="btn">Cancel</button>
            </div>
            
            <div id="adminNoticeHelp" class="page-subtitle" style="margin-top:8px;">Fill in details and click Save.</div>
          </div>
        </section>

        <section id="shift-swaps" class="section panel" style="display:none;">
          <h2>Shift Swaps</h2>
          <p>View pending swap requests and execute/decline them. History of all executed swaps with full audit trail.</p>

          <div class="subtabs">
            <button class="subtab is-active" data-swaps-page="pending" type="button">Pending Requests</button>
            <button class="subtab" data-swaps-page="executed" type="button">Executed Swaps</button>
          </div>

          <!-- Pending requests view -->
          <div id="swapsPendingPage" class="swaps-page" style="display:block;">
            <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
              <input id="adminSwapSearch" class="control" placeholder="Search by staff name..." style="flex:1; min-width:200px;" />
              <select id="adminSwapStatusFilter" class="control" style="min-width:150px;">
                <option value="">All statuses</option>
                <option value="pending">Pending</option>
                <option value="accepted_by_counterparty">Accepted (awaiting admin)</option>
                <option value="declined_by_counterparty">Declined by staff</option>
              </select>
            </div>
            <div id="adminSwapsPendingList" style="border:1px solid var(--line); border-radius:12px; background:#fff; overflow:hidden;"></div>
          </div>

          <!-- Executed swaps view -->
          <div id="swapsExecutedPage" class="swaps-page" style="display:none;">
            <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
              <input id="adminSwapHistorySearch" class="control" placeholder="Search by staff name..." style="flex:1; min-width:200px;" />
              <select id="adminSwapMethodFilter" class="control" style="min-width:150px;">
                <option value="">All methods</option>
                <option value="admin_direct">Admin Direct</option>
                <option value="staff_approved">Staff Approved</option>
              </select>
            </div>
            <div id="adminSwapsExecutedList" style="border:1px solid var(--line); border-radius:12px; background:#fff; overflow:hidden;"></div>
          </div>
        </section>

        <section id="shift-catalogue" class="section panel" style="display:none;">
          <h2>Shift Catalogue</h2>
          <p>Define shifts, eligibility rules, and styling metadata.</p>

          <div style="display:flex; gap:8px; margin-bottom:12px;">
            <button id="createShiftBtn" class="btn primary" type="button">Create shift</button>
          </div>

          <div id="shiftsList" style="border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#fff;"></div>

          <!-- Edit shift modal -->
          <div id="editShiftModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; padding:20px; overflow-y:auto;">
            <div style="background:#fff; border-radius:14px; max-width:600px; margin:40px auto; padding:24px;">
              <h3 id="editShiftTitle" style="margin:0 0 16px 0; font-size:16px; font-weight:700;">Edit Shift</h3>
              
              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Code</h4>
                <input id="editShiftCode" class="control" placeholder="e.g., LD" readonly style="background:#f5f5f5;" />
              </div>

              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Label</h4>
                <input id="editShiftLabel" class="control" placeholder="e.g., Late Day" />
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                <div class="field">
                  <h4 style="margin:0 0 8px 0;">Start Time (HH:MM)<span style="font-size:11px; color:var(--muted);"> optional</span></h4>
                  <input id="editShiftStart" class="control" placeholder="e.g., 09:00" />
                </div>
                <div class="field">
                  <h4 style="margin:0 0 8px 0;">End Time (HH:MM)<span style="font-size:11px; color:var(--muted);"> optional</span></h4>
                  <input id="editShiftEnd" class="control" placeholder="e.g., 17:00" />
                </div>
              </div>

              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Hours Total<span style="font-size:11px; color:var(--muted);"> optional</span></h4>
                <input id="editShiftHours" class="control" type="number" placeholder="e.g., 8.0" />
              </div>

              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Shift Type</h4>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px;">
                  <input type="checkbox" id="editShiftIsTimeOff" /> This is a time-off code (e.g., Leave, Off, Sick)
                </label>
              </div>

              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Eligible Staff Grades</h4>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; margin-bottom:6px;">
                  <input type="checkbox" id="editShiftNA" /> Nursing Assistant
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; margin-bottom:6px;">
                  <input type="checkbox" id="editShiftSN" /> Staff Nurse
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px;">
                  <input type="checkbox" id="editShiftCN" /> Charge Nurse
                </label>
              </div>

              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Styling</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:8px;">
                  <div>
                    <label style="font-size:11px; color:var(--muted); display:block; margin-bottom:4px;">Fill Color</label>
                    <input id="editShiftFill" class="control" type="color" value="#ffffff" style="height:40px;" />
                  </div>
                  <div>
                    <label style="font-size:11px; color:var(--muted); display:block; margin-bottom:4px;">Text Color</label>
                    <input id="editShiftText" class="control" type="color" value="#000000" style="height:40px;" />
                  </div>
                </div>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; margin-bottom:4px;">
                  <input type="checkbox" id="editShiftBold" /> Bold
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px;">
                  <input type="checkbox" id="editShiftItalic" /> Italics
                </label>
              </div>

              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Where can this shift be picked?</h4>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; margin-bottom:6px;">
                  <input type="checkbox" id="editShiftRequests" /> In shift requests
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; margin-bottom:6px;">
                  <input type="checkbox" id="editShiftRotaDraft" /> In rota draft
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; margin-bottom:6px;">
                  <input type="checkbox" id="editShiftRotaPost" /> In rota (post-publish)
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px;">
                  <input type="checkbox" id="editShiftAvailable" /> In available shifts
                </label>
              </div>

              <div class="field" style="margin-bottom:12px; text-align:center;">
                <h4 style="margin:0 0 8px 0;">Style Preview</h4>
                <div id="editShiftPreview" style="padding:8px 12px; border-radius:6px; font-size:12px; font-weight:600; background:#ffffff; color:#000000; display:inline-block; min-width:100px;">
                  Preview
                </div>
              </div>

              <div style="display:flex; gap:8px; margin-top:16px;">
                <button id="saveShiftBtn" class="btn primary" type="button">Save</button>
                <button id="closeEditShiftBtn" class="btn" type="button">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Create shift modal -->
          <div id="createShiftModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; padding:20px; overflow-y:auto;">
            <div style="background:#fff; border-radius:14px; max-width:600px; margin:40px auto; padding:24px;">
              <h3 style="margin:0 0 16px 0; font-size:16px; font-weight:700;">Create New Shift</h3>
              
              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Code</h4>
                <input id="newShiftCode" class="control" placeholder="e.g., LD" />
              </div>

              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Label</h4>
                <input id="newShiftLabel" class="control" placeholder="e.g., Late Day" />
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                <div class="field">
                  <h4 style="margin:0 0 8px 0;">Start Time (HH:MM)<span style="font-size:11px; color:var(--muted);"> optional</span></h4>
                  <input id="newShiftStart" class="control" placeholder="e.g., 09:00" />
                </div>
                <div class="field">
                  <h4 style="margin:0 0 8px 0;">End Time (HH:MM)<span style="font-size:11px; color:var(--muted);"> optional</span></h4>
                  <input id="newShiftEnd" class="control" placeholder="e.g., 17:00" />
                </div>
              </div>

              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Hours Total<span style="font-size:11px; color:var(--muted);"> optional</span></h4>
                <input id="newShiftHours" class="control" type="number" placeholder="e.g., 8.0" />
              </div>

              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Shift Type</h4>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px;">
                  <input type="checkbox" id="newShiftIsTimeOff" /> This is a time-off code (e.g., Leave, Off, Sick)
                </label>
              </div>

              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Eligible Staff Grades</h4>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; margin-bottom:6px;">
                  <input type="checkbox" id="newShiftNA" /> Nursing Assistant
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; margin-bottom:6px;">
                  <input type="checkbox" id="newShiftSN" /> Staff Nurse
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px;">
                  <input type="checkbox" id="newShiftCN" /> Charge Nurse
                </label>
              </div>

              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Styling</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:8px;">
                  <div>
                    <label style="font-size:11px; color:var(--muted); display:block; margin-bottom:4px;">Fill Color</label>
                    <input id="newShiftFill" class="control" type="color" value="#ffffff" style="height:40px;" />
                  </div>
                  <div>
                    <label style="font-size:11px; color:var(--muted); display:block; margin-bottom:4px;">Text Color</label>
                    <input id="newShiftText" class="control" type="color" value="#000000" style="height:40px;" />
                  </div>
                </div>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; margin-bottom:4px;">
                  <input type="checkbox" id="newShiftBold" /> Bold
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px;">
                  <input type="checkbox" id="newShiftItalic" /> Italics
                </label>
              </div>

              <div class="field" style="margin-bottom:12px;">
                <h4 style="margin:0 0 8px 0;">Where can this shift be picked?</h4>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; margin-bottom:6px;">
                  <input type="checkbox" id="newShiftRequests" /> In shift requests
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; margin-bottom:6px;">
                  <input type="checkbox" id="newShiftRotaDraft" /> In rota draft
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px; margin-bottom:6px;">
                  <input type="checkbox" id="newShiftRotaPost" /> In rota (post-publish)
                </label>
                <label style="display:flex; gap:6px; align-items:center; font-size:12.5px;">
                  <input type="checkbox" id="newShiftAvailable" /> In available shifts
                </label>
              </div>

              <div class="field" style="margin-bottom:12px; text-align:center;">
                <h4 style="margin:0 0 8px 0;">Style Preview</h4>
                <div id="newShiftPreview" style="padding:8px 12px; border-radius:6px; font-size:12px; font-weight:600; background:#ffffff; color:#000000; display:inline-block; min-width:100px;">
                  Preview
                </div>
              </div>

              <div style="display:flex; gap:8px; margin-top:16px;">
                <button id="createShiftSubmitBtn" class="btn primary" type="button">Create</button>
                <button id="closeCreateShiftBtn" class="btn" type="button">Cancel</button>
              </div>
            </div>
          </div>
        </section>

        <section id="patterns" class="section panel" style="display:none;">
          <h2>Scheduling Patterns</h2>
          <p>Define reusable scheduling templates and view assignments.</p>

          <div style="border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#fff;">
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
              <thead style="background:#f7f9fc; border-bottom:1px solid var(--line);">
                <tr>
                  <th style="padding:12px 16px; text-align:left; font-weight:600; color:var(--ink);">Pattern Name</th>
                  <th style="padding:12px 16px; text-align:left; font-weight:600; color:var(--ink);">Type</th>
                  <th style="padding:12px 16px; text-align:left; font-weight:600; color:var(--ink);">Cycle (weeks)</th>
                  <th style="padding:12px 16px; text-align:left; font-weight:600; color:var(--ink);">Weekly Targets</th>
                  <th style="padding:12px 16px; text-align:left; font-weight:600; color:var(--ink);">Requires Anchor</th>
                  <th style="padding:12px 16px; text-align:left; font-weight:600; color:var(--ink);">Notes</th>
                </tr>
              </thead>
              <tbody id="patternsList">
                <tr style="border-top:1px solid var(--line);">
                  <td colspan="6" style="padding:12px 16px; color:var(--muted); text-align:center;">Loading patterns...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <section id="staffing-requirements" class="section panel" style="display:none;">
          <h2>Staffing Requirements</h2>
          <p>Set required daily staffing levels for each period. Staff counts are highlighted in orange when short.</p>

          <div style="margin-bottom:16px;">
            <label for="staffingPeriodSelect" style="display:block; font-size:13px; font-weight:600; margin-bottom:6px;">Period:</label>
            <select id="staffingPeriodSelect" class="control" style="max-width:300px;">
              <option value="">Loading...</option>
            </select>
          </div>

          <div id="staffingRequirementsContainer" style="margin-top:16px;"></div>
        </section>

        <section id="staffing" class="section panel" style="display:none;">
          <h2>Staffing Defaults</h2>
          <p>Set default required staffing levels (applies to all periods).</p>
          
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; max-width:400px;">
            <div class="field">
              <h4 style="margin:0 0 6px 0;">Day Shift - SN/CN</h4>
              <input id="staffingDaySn" type="number" step="0.5" min="0" class="control" style="width:100%;" />
            </div>
            <div class="field">
              <h4 style="margin:0 0 6px 0;">Day Shift - NA</h4>
              <input id="staffingDayNa" type="number" step="0.5" min="0" class="control" style="width:100%;" />
            </div>
            <div class="field">
              <h4 style="margin:0 0 6px 0;">Night Shift - SN/CN</h4>
              <input id="staffingNightSn" type="number" step="0.5" min="0" class="control" style="width:100%;" />
            </div>
            <div class="field">
              <h4 style="margin:0 0 6px 0;">Night Shift - NA</h4>
              <input id="staffingNightNa" type="number" step="0.5" min="0" class="control" style="width:100%;" />
            </div>
          </div>
          
          <button id="saveStaffingBtn" class="btn primary" style="margin-top:12px;">Save Defaults</button>
          <p id="staffingMsg" style="margin-top:8px; font-size:12px; color:#666;"></p>
        </section>

        <section id="available-shifts" class="section panel" style="display:none;">
          <h2>Available Shifts</h2>
          <p>Post-publish shortage marketplace (admin approves, nothing auto-inserts).</p>
          <div class="actions">
            <button class="btn primary" type="button">Create Available Shift</button>
            <button class="btn" type="button">Review Bids</button>
          </div>
        </section>

        <section id="reports" class="section panel" style="display:none;">
          <h2>Reports</h2>
          <p>Draft-only snapshots: distribution, request deviations, compliance.</p>
          <div class="actions">
            <button class="btn primary" type="button">Generate Report</button>
            <button class="btn" type="button">View History</button>
          </div>
        </section>

        <section id="audit" class="section panel" style="display:none;">
          <h2>Superadmin Audit Trail</h2>
          <p>View all system actions, impersonations, and security events.</p>
          
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; align-items:center;">
            <select id="auditFilterAction" class="control" style="min-width:180px;">
              <option value="">All Actions</option>
              <option value="shift">Shift Changes</option>
              <option value="swap">Swap Requests</option>
              <option value="request">Time Off Requests</option>
              <option value="period">Period Management</option>
              <option value="user">User Management</option>
              <option value="admin">Admin Actions</option>
              <option value="impersonate">Impersonations</option>
              <option value="login">Login Events</option>
            </select>
            
            <input id="auditFilterActorUser" class="control" placeholder="Who actioned..." style="min-width:180px;" />
            
            <input id="auditFilterTargetUser" class="control" placeholder="Target user..." style="min-width:180px;" />
            
            <label style="font-size:12px; color:var(--dim);">From:</label>
            <input id="auditFilterStartDate" class="control" type="date" style="max-width:150px;" />
            
            <label style="font-size:12px; color:var(--dim);">To:</label>
            <input id="auditFilterEndDate" class="control" type="date" style="max-width:150px;" />
            
            <button id="auditLoadBtn" class="btn primary" type="button">Load Logs</button>
            <button id="auditExportBtn" class="btn" type="button">Export CSV</button>
            <button id="auditClearFiltersBtn" class="btn" type="button">Clear Filters</button>
          </div>

          <div id="auditLogsTable" style="border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#fff; margin-top:12px;">
            <div style="padding:12px; text-align:center; color:var(--muted);">Click "Load Logs" to view audit trail</div>
          </div>
        </section>

        <section id="system" class="section panel" style="display:none;">
          <h2>System Settings</h2>
          <p>Global configuration (bank holidays, limits, visibility rules).</p>
          <div class="actions">
            <button class="btn" type="button">Manage Bank Holidays</button>
            <button class="btn" type="button">Set Limits</button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <!-- config.js already loaded in <head>, removed duplicate -->
  <script src="js/notifications-shared.js" defer></script>
  <script src="js/view-as.js?v=8"></script>
  <script src="js/admin-status-dashboard.js"></script>
  <script src="js/admin.js"></script>
  <script src="js/admin-leave-management.js"></script>
  <script src="js/audit-trail-enhanced.js"></script>
  <script src="js/admin-periods.js"></script>
  <script>
    // Staffing defaults management
    const staffingDaySn = document.getElementById("staffingDaySn");
    const staffingDayNa = document.getElementById("staffingDayNa");
    const staffingNightSn = document.getElementById("staffingNightSn");
    const staffingNightNa = document.getElementById("staffingNightNa");
    const saveStaffingBtn = document.getElementById("saveStaffingBtn");
    const staffingMsg = document.getElementById("staffingMsg");

    // Load defaults on page load
    function loadStaffingDefaults() {
      const defaults = JSON.parse(localStorage.getItem("calpeward.staffing_defaults") || 
        '{"day_sn_required":3,"day_na_required":3,"night_sn_required":2,"night_na_required":2}');
      staffingDaySn.value = defaults.day_sn_required;
      staffingDayNa.value = defaults.day_na_required;
      staffingNightSn.value = defaults.night_sn_required;
      staffingNightNa.value = defaults.night_na_required;
    }

    // Save defaults
    saveStaffingBtn.addEventListener("click", () => {
      const defaults = {
        day_sn_required: parseFloat(staffingDaySn.value) || 3,
        day_na_required: parseFloat(staffingDayNa.value) || 3,
        night_sn_required: parseFloat(staffingNightSn.value) || 2,
        night_na_required: parseFloat(staffingNightNa.value) || 2
      };
      localStorage.setItem("calpeward.staffing_defaults", JSON.stringify(defaults));
      staffingMsg.textContent = "‚úì Defaults saved! (reload rota to apply)";
      staffingMsg.style.color = "#28a745";
      setTimeout(() => { staffingMsg.textContent = ""; }, 3000);
    });

    // Load on page load
    document.addEventListener("DOMContentLoaded", loadStaffingDefaults);

    // Mobile Mode Toggle
    const mobileToggle = document.getElementById('mobileToggle');
    const mobileToggleIcon = document.getElementById('mobileToggleIcon');
    const mobileToggleText = document.getElementById('mobileToggleText');
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const MOBILE_MODE_KEY = 'calpeward.mobile_mode';

    // Check saved preference or default to false
    let mobileMode = localStorage.getItem(MOBILE_MODE_KEY) === 'true';

    // Auto-enable mobile mode on small screens (but allow override)
    if (!localStorage.getItem(MOBILE_MODE_KEY) && window.innerWidth < 768) {
      mobileMode = true;
    }

    function updateMobileMode() {
      if (mobileMode) {
        document.body.classList.add('mobile-mode');
        mobileToggleIcon.textContent = 'üñ•Ô∏è';
        mobileToggleText.textContent = 'Desktop Mode';
        hamburger.style.display = 'block';
      } else {
        document.body.classList.remove('mobile-mode');
        mobileToggleIcon.textContent = 'üì±';
        mobileToggleText.textContent = 'Mobile Mode';
        hamburger.style.display = 'none';
        sidebar.classList.remove('is-open');
        mobileOverlay.classList.remove('is-visible');
      }
      localStorage.setItem(MOBILE_MODE_KEY, mobileMode);
    }

    mobileToggle.addEventListener('click', () => {
      mobileMode = !mobileMode;
      updateMobileMode();
    });

    hamburger.addEventListener('click', () => {
      sidebar.classList.add('is-open');
      mobileOverlay.classList.add('is-visible');
    });

    mobileOverlay.addEventListener('click', () => {
      sidebar.classList.remove('is-open');
      mobileOverlay.classList.remove('is-visible');
    });

    // Close sidebar when clicking nav links in mobile mode
    document.querySelectorAll('.nav a').forEach(link => {
      link.addEventListener('click', () => {
        if (mobileMode) {
          sidebar.classList.remove('is-open');
          mobileOverlay.classList.remove('is-visible');
        }
      });
    });

    // Initialize on page load
    updateMobileMode();
  </script>
</body>
</html>
